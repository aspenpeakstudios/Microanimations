<html>
<head>
<title>Timeline Example</title> 
<link rel='stylesheet' href='css/timeline.css' />
</head>

<body>
    <h1>JS Timeline Example</h1>
    <div class='timeline-container'>
        <button id="backBtn"> Back </button>
        <div id="timeline" class="timeline"></div>
        <button id="forwardBtn"> Forward </button>
    </div>
    <div class='horizontal-scroller snaps-inline'></div>
    <div class='footer'>
        <span id="ScrollLeft"></span>
        <div id="debug"></div>
    </div>
</body>

<script src="/js/animation.js"></script>

<script>

// Data
const events = [
    {yearStart: 1998, yearEnd:2003, name: "University of Wisconsin - Platteville", tools: ".NET, JAVA, Visual Basic", description: "Graduated with a degree in Computer Science and a focus on Software Engineering."},
    {yearStart: 2000, yearEnd:2006, name: "Wisconsin Air National Guard", tools: "HTML, CSS, Javascript", description: "Computer support and a bit of web development in the Air National Guard"},
    {yearStart: 2004, yearEnd:2014, name: "Northwestern Mutual", tools: "Java, .Net, Message Queues, Middleware", description: "Worked in a number of roles and teams during my 10 years at Northwestern Mutual."}, 
    {yearStart: 2014, yearEnd:2021, name: "NAH", tools: "Web Design, Marketing, Planning, Leading", description: "Owned small business"}, 
    {yearStart: 2018, yearEnd:2021, name: "M.J. Electric", tools:"Javascript, .Net, React, Adobe XD", description: "Worked on the web development team."}, 
    {yearStart: 2021, yearEnd:2023, name: "Self Employed", tools: "React, Remix, Figma", description: "Taking a break to live life."}, 
]

// ----------------------------------------------------------------------------------------------------------
// ------------------------------ Event Handlers ------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------------
window.onload = () => {

    // Timeline Event Handlers
    document.querySelector('.timeline').addEventListener('click', handleEventMarkerClick, false);
    document.querySelector('#backBtn').addEventListener('click', () => {updateSelectedIndexByDirection(-1)}, false);
    document.querySelector('#forwardBtn').addEventListener('click', () => {updateSelectedIndexByDirection(1)}, false);

    // Slideshow Event Handlers    
    document.querySelector('.horizontal-scroller').setAttribute("tabindex", 0);  // Div needs a [tab index] or the key press events won't work.
    document.querySelector('.horizontal-scroller').addEventListener('keydown', function(e) {
            console.log("Key Press");
            const key = event.key; // "ArrowRight", "ArrowLeft", "ArrowUp", or "ArrowDown"
            switch (event.key) {
                case "ArrowLeft":
                    //console.log("Left Key Pressed")
                    updateSelectedIndexByDirection(-1);                    
                    break;
                case "ArrowRight":
                    //console.log("Right Key Pressed")
                    updateSelectedIndexByDirection(1);
                    break;                
            }
        });    
}


// Attempts to increment or decrement the selected index and 
// then update the timeline and slide show.
function updateSelectedIndexByDirection(direction) {
    let newIndex = selectedIndex + direction;    

    // boundary checks
    if (newIndex >= 0 && newIndex < events.length) {        
        selectedIndex = newIndex;
        updateSlideShow(selectedIndex);
    }
}

function handleEventMarkerClick(e) {        

    // Get the Parent Container
    let el = event.target;    
    
    // Since we're using event delegation, make sure we end up with
    // an element with an index, or exit early.
    if (el.classList.contains('timeline')) return;
    if (!el.classList.contains('event-marker')) {
        el = el.parentElement;
    }

    // Get the index
    let index = parseInt(el.dataset.index);

    // Redraw the timeline and slideshow
    updateSlideShow(index);
}   

// Central location for updating the UI Timeline and Slideshow)
function updateSlideShow(index) {

    if (Number.isInteger(index)) {

        // Updates the Event Timeline
        timeline_SetNewSelectedEvent(index);

        // find event details container related to the new index.
        let element = document.querySelector(`.event-details-element[data-index="${index}"]`);    

        // Moves slideshow to the new slide
        slideShow_SnapScrollToNewSlide(element);    
    }
    else {
        console.error("index parameter is invalid.");
    }
}
 
// Moves the selected event in the Timeline to a new event.
function timeline_SetNewSelectedEvent(index) {    
    // Update our global state.
    selectedIndex = index;

    // Get the start and end years.
    let year = events[index].yearStart;
    let yearEnd = events[index].yearEnd;

    // Fade back in any elements which were behind another element during the last Timeline render.
    const markers = document.querySelectorAll('.fade-to-back');           
    markers.forEach(marker => {        
        marker.classList.remove('fade-to-back');
    });


    // Loop through all the events to remove the previously active event and set the new event.
    events.map((event) => {        
                
        // Determine if any events are in the middle of the selected timeline.
        // If any are in the middle, fade them into the background.
        if ((year != event.yearStart) && (year < event.yearStart) && (event.yearStart < yearEnd)) {
            let markerEl = document.getElementById(`${event.yearStart}Marker`);            
            markerEl.classList.add('fade-to-back');            
        } 

        // Check if we are on the new active event or not and update the timeline accordingly.        
        updateSelectedEvent(event, event.yearStart !== year);        
    });
}

// Updates the details slideshow
function updateSelectedEvent(event, reset = false) {        
    let container = document.getElementById(`${event.yearStart}Marker`);
    let el = document.getElementById(`${event.yearStart}Marker`).querySelector('.event-selected');            
    
    // FUTURE IMPROVEMENT - don't like how timeline is hardcoded here.
    let widthPerTick = document.querySelector('.timeline').dataset.widthPerTick;
    let width = (event.yearEnd - event.yearStart) * widthPerTick;

    // Add a bit of a delay so the Timeline and Slide show move at the same time.
    let delay = (reset ? 0 : 250);

    window.setTimeout(() => {
        if (reset) {
                width = 0;
                el.classList.add('no-transition');
            }
            else {
                el.classList.remove('no-transition');    
            }
            el.style.width = width;
        }, delay)
}

// When the mouse is clicked, save the current state.
function handleMouseDown(e) {    
    mouseState.isDown = true;
    mouseState.startX = e.pageX - mouseState.parentElement.offsetLeft;
    mouseState.scrollLeft = mouseState.parentElement.scrollLeft;
    mouseState.parentElement.classList.add('mouseDown');
}
// When the mouse button is let up, attempt to update the timeline and slideshow.
function handleMouseUp(e) { 
    // Reset Stuff - 1
    mouseState.isDown = false;   
    mouseState.parentElement.classList.remove('mouseDown'); 

    // If mouse was clicked but we haven't recorded any direction, assume user is not trying to 
    // update the slideshow
    if (mouseState.direction == 0) return;

    // Calculate which slide is most visible on the screen and scroll to it.
    let slidesInView = getElementsOnScreen('.event-details-element');
    
    // Choose the new slide and move to it.
    if (slidesInView.length > 0) {        
        let el = slidesInView[0];
        if (mouseState.direction < 0) {
            el = slidesInView[slidesInView.length -1];  // Get the last element (which should be the right most one)
        }

        const index = parseInt(el.dataset.index);        
        updateSlideShow(index);
    }

    // Reset stuff - 2    
    mouseState.direction = 0;
}
function handleMouseMove(e) {    
    //debugPrintScrollPosition('.horizontal-scroller', 'ScrollLeft');

    // if the mouse is not clicked, don't proceed.
    if (!mouseState.isDown) return;
    e.preventDefault();

    // Calculate how much the mouse has moved and update the scroll position
    const x = e.pageX - mouseState.parentElement.offsetLeft;
    const walk = (x - mouseState.startX) * 1;    
    mouseState.parentElement.scrollLeft = mouseState.scrollLeft - walk;
    mouseState.direction = (walk > 0) ? 1 : -1;    
}


// ----------------------------------------------------------------------------------------------------------
// ------------------------------ Render Methods ------------------------------------------------------------
// ----------------------------------------------------------------------------------------------------------
function renderEventMarker(index, event, parentEl, offsetX, offsetWidth) {   
    let displayEndCapHtml = 'display:none;';    // Not used anymore    

    let html = `<div id='${event.yearStart}Marker' data-year=${event.yearStart} data-index=${index} class='event-marker' style='left:${offsetX}px'>
                    <div class='event-circle'></div>
                    <div class='event-arm'></div>
                    <div class='event-text'>${event.yearStart}</div>
                    <div class='event-selected' style='width:${offsetWidth}; overflow-y: hidden; display: flex; flex-direction: row; justify-content: flex-end;'>
                        <div style='${displayEndCapHtml} width: 20px; height: 20px; background-color: red;'></div>
                    </div>
                </div>`;

    parentEl.innerHTML += html;    
}
function renderYearTick(year, parentEl, offsetX) {
    // Check if there is an event marker for this year.  If so, don't do anything.    
    //let markers = document.querySelector(`.event-details-element[data-year="${selectedIndex}"]`);
    let markers = events.find(event => event.yearStart == year);
    
    if (markers !== undefined) return;

    let html = "";
    if (year % 5 === 0) {
        html = `<div class='year-marker' style='left:${offsetX}px'>                    
                        <div class='year-arm' style='height: ${25}px; top: -12px;'></div>                    
                        <div class='year-text' style='display:none'>${year}</div>                    
                    </div>`;
    }
    else {
        html = `<div class='year-marker'>                    
                        <div class='year-arm' style='left:${offsetX}px'></div>                    
                    </div>`;
    }

    parentEl.innerHTML += html;
}
function renderEventHeader(yearStart, yearEnd, name, parentEl) {
    let html = `<div>${yearStart} - ${yearEnd}</div>
                <div>${name}</div>
                `;
    parentEl.innerHTML = html;
}
function renderEventSummary(tools, summary, parentEl) {
    let html = `<div class='event-tools'>${tools}</div>
                <div>At a glance:</div>
                <div class='event-summary'>${summary}</div>
                `;
    parentEl.innerHTML = html;
}
function renderEventsHorizontal(events, parentEl) {
    parentEl.innerHTML = "";

    // loop through all the events
    events.map((event, index) => {
        // Create an element and attach event listeners, then template the rest of the element's contents.
        let container = document.createElement("div");
        container.classList.add('event-details-element');
        container.dataset.index = index;
        container.addEventListener('mousedown', handleMouseDown);
        container.addEventListener('mouseup', handleMouseUp);
        container.addEventListener('mousemove', handleMouseMove);
        container.addEventListener('mouseleave', (e) => { if (mouseState.isDown) handleMouseUp(e);});
        
        let html = `<h1>Event Details Container</h1>                    
                    <!-- Event Header -->
                    <div class='event-header'>
                        <div>${event.yearStart} - ${event.yearEnd}</div>
                        <div>${event.name}
                    </div>
                    <!-- Event Summary -->
                    <div class='event-summary'>
                        <div class='event-tools'>${event.tools}</div>
                        <div>At a glance:</div>
                        <div class='event-summary'>${event.summary}</div>
                    </div>
                    <!-- Event Body -->
                    <div class='event-body'></div>
                    `;
        container.innerHTML = html;
        parentEl.appendChild(container);
    });
}

// This creates the timeline and gets it up and running.
function initTimeline(timeline_selector, startYear, endYear) {
    let timelineEl = document.querySelector(timeline_selector);
    
    // Calculate some stuff needed for rendering
    const numTicks = endYear - startYear;
    const timelineWidth = timelineEl.offsetWidth;
    const widthPerTick = timelineWidth / numTicks;
    timelineEl.dataset.widthPerTick = widthPerTick;     // Store this for later  <-- IMPROVE THIS

    // Add year ticks to the timeline
    let s = startYear; let offsetX = -10;
    for(s; s <= endYear; s++) {    
        renderYearTick(s, timelineEl, offsetX);
        offsetX += widthPerTick;
    }

    // Add each event as a marker on the timeline
    events.map((event, index) => {    
        const offsetX = (event.yearStart - startYear) * widthPerTick - 20;      // WHY 20?
        renderEventMarker(index, event, timelineEl, offsetX, 0);
    });

    // Add each event as a slide in the slideshow
    renderEventsHorizontal(events, document.querySelector('.horizontal-scroller'));
    
    // Start the slideshow
    window.setTimeout(() => {    
        updateSlideShow(selectedIndex);    
    }, 1000);
}



// ------------------------------ DOCUMENT IS LOADED --------------------------------------------------------

// Activate
let selectedIndex = 0;

// Mouse variables
let mouseState = { parentElement: document.querySelector('.horizontal-scroller'), 
                   isDown:false, 
                   startX:0, 
                   scrollLeft:0,
                   direction:0
                }

// Fire up the timeline and slideshow!
initTimeline('.timeline', 1995, 2025);

</script>
</html>